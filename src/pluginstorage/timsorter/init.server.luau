--[[
	TimSorter Plugin
	Sorts unlocks within item configs
]]
-- TODO: MAKE TS ACTUALLY SORT BOTH IN THE
-- UNLOCKS AND THE CONFIG INSIDE THE MODULE ITSELF

if not game.GameId == 8782368102 then
	warn("This plugin is specific to one game currently")
	return
end

local React = require(script.Packages.React)
local ReactRoblox = require(script.Packages.ReactRoblox)
local App = require(script.App)

local ServerScriptService = game:GetService("ServerScriptService")

local CONFIG_MODULE_NAME = "GeneratedItemConfigs"
local BACKUPS_FOLDER_NAME = "GeneratedItemConfigsBackups"

-- Plugin UI setup
local widget = plugin:CreateDockWidgetPluginGui(
	"TimSorter",
	DockWidgetPluginGuiInfo.new(Enum.InitialDockState.Right, true, false, 300, 500, 250, 400)
)
widget.Title = "TimSorter - Unlock Reorderer"

local toolbar = plugin:CreateToolbar("TimSorter")
local toggleButton = toolbar:CreateButton("Toggle TimSorter", "Open/Close the sorter", "rbxassetid://732391129")

-- React root
local root = nil

-- Save function
local function saveConfigs(configs: { any })
	warn(configs)
	local lines = {}
	table.insert(lines, "-- Generated by TimSorter Plugin")
	table.insert(lines, "return {")

	for i, configData in ipairs(configs) do
		warn(i, ")", configData.DisplayName)
		table.insert(lines, "\t{")
		table.insert(lines, string.format('\t\tItemId = "%s",', configData.ItemId))
		-- Serialize DisplayName with proper escaping
		table.insert(
			lines,
			string.format('\t\tDisplayName = "%s",', (configData.DisplayName or configData.ItemId):gsub('"', '\\"'))
		)
		table.insert(lines, string.format("\t\tPrice = %d,", configData.Price or 0))

		-- Add the Prefab attribute
		if configData.Prefab then
			table.insert(
				lines,
				string.format('\t\tPrefab = workspace.Items.Value:FindFirstChild("%s"),', configData.ItemId)
			)
		end

		if configData.Unlocks and #configData.Unlocks > 0 then
			table.insert(lines, "\t\tUnlocks = {")
			for j, unlockId in ipairs(configData.Unlocks) do
				table.insert(lines, string.format('\t\t\t"%s",', unlockId))
			end
			table.insert(lines, "\t\t},")
		end

		if configData.UnlockedBy and #configData.UnlockedBy > 0 then
			table.insert(lines, "\t\tUnlockedBy = {")
			for j, unlockedById in ipairs(configData.UnlockedBy) do
				table.insert(lines, string.format('\t\t\t"%s",', unlockedById))
			end
			table.insert(lines, "\t\t},")
		end

		if configData.ItemSlot ~= nil then
			if type(configData.ItemSlot) == "number" then
				table.insert(lines, string.format("\t\tItemSlot = %d,", configData.ItemSlot))
			else
				table.insert(
					lines,
					string.format('\t\tItemSlot = "%s",', tostring(configData.ItemSlot):gsub('"', '\\"'))
				)
			end
		end

		table.insert(lines, "\t},")
	end

	table.insert(lines, "}")
	local finalSource = table.concat(lines, "\n")

	local configModule = ServerScriptService:FindFirstChild(CONFIG_MODULE_NAME)
	if not configModule then
		configModule = Instance.new("ModuleScript", ServerScriptService)
		configModule.Name = CONFIG_MODULE_NAME
	end

	configModule.Source = finalSource
	local oldModule = configModule
	local newModule = Instance.new("ModuleScript")
	newModule.Name = CONFIG_MODULE_NAME
	newModule.Source = finalSource
	newModule.Parent = ServerScriptService

	-- Replace the old module if it existed
	if oldModule and oldModule ~= newModule then
		oldModule:Destroy()
	end

	-- Ensure configModule points to the freshly created module
	configModule = newModule

	print("‚úÖ TimSorter: Created new module and replaced " .. CONFIG_MODULE_NAME)

	-- Create backup
	local backupsFolder = ServerScriptService:FindFirstChild(BACKUPS_FOLDER_NAME)
	if not backupsFolder then
		backupsFolder = Instance.new("Folder", ServerScriptService)
		backupsFolder.Name = BACKUPS_FOLDER_NAME
	end

	local timestamp = os.date("%Y%m%d_%H%M%S")
	local backup = configModule:Clone()
	backup.Name = CONFIG_MODULE_NAME .. "_" .. timestamp
	backup.Parent = backupsFolder
	print("üóÇÔ∏è TimSorter: Backup created:", BACKUPS_FOLDER_NAME .. "/" .. timestamp)
end

-- Render function
local function renderApp()
	if root then
		root:unmount()
	end

	local configModule = ServerScriptService:FindFirstChild(CONFIG_MODULE_NAME)

	root = ReactRoblox.createRoot(widget)
	root:render(React.createElement(App, {
		configModule = configModule,
		onSave = saveConfigs,
	}))
end

-- Toggle widget
toggleButton.Click:Connect(function()
	widget.Enabled = not widget.Enabled
end)

-- Render when widget opens
widget:GetPropertyChangedSignal("Enabled"):Connect(function()
	if widget.Enabled then
		renderApp()
	end
end)

-- Cleanup on plugin unload
plugin.Unloading:Connect(function()
	if root then
		root:unmount()
		root = nil
	end
end)

-- Initial render if widget is already open
if widget.Enabled then
	renderApp()
end

print("‚úÖ TimSorter plugin loaded!")
